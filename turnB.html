<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>DQ風タッチバトル</title>
<style>

#ui{
  position:fixed; left:10px; right:10px; bottom:10px;  /* 画面下に固定 */
  z-index:3;
}
#hud{
  position:fixed; left:10px; right:10px; top:10px;     /* 上のステータスも固定 */
  z-index:3;
}
#wrap{ position:fixed; inset:0; }  /* そのままでOK */
  :root{
    --bg:#0e1016; --panel:#1a1e29; --accent:#5dd4ff; --text:#e8f1ff; --muted:#9fb3c8; --enemy:#ff8aa0; --player:#87ffa8;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif;}
  #wrap{position:fixed; inset:0; display:grid; grid-template-rows: 1fr auto auto; gap:8px; padding:10px;}
  canvas{width:100%; height:100%; background:linear-gradient(#1a2130, #0f1420);}
  .panel{background:var(--panel); border:1px solid #2b3547; border-radius:10px; padding:10px;}
  #hud{display:flex; gap:10px; justify-content:space-between; align-items:center;}
  .bar{height:8px; background:#2b3547; border-radius:6px; overflow:hidden}
  .hp{height:100%; background:linear-gradient(90deg, #33ff88, #1ec6ff); transition:width .25s}
  .ehp{height:100%; background:linear-gradient(90deg, #ff5577, #ffc171); transition:width .25s}
  .row{display:flex; gap:10px; align-items:center;}
  .name{font-weight:700;}
  .stat{font-size:12px; color:var(--muted);}
  #cmds, #skills{display:grid; grid-template-columns:repeat(2, 1fr); gap:8px;}
  button{padding:14px 10px; font-size:16px; border-radius:10px; border:1px solid #2b3547; background:#121722; color:var(--text); }
  button:active{transform:translateY(2px); opacity:.9}
  .sub{font-size:14px; color:var(--muted);}
  #log{min-height:2.5em; line-height:1.3}
  .blink{animation:blink .5s step-end 4;}
  @keyframes blink{50%{opacity:.3}}
  .shake{animation:shake .25s ease;}
  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-4px)}100%{transform:translateX(0)}}
  .float{position:absolute; pointer-events:none; font-weight:700; text-shadow:0 2px 0 #000;}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="cv" width="640" height="360"></canvas>

  <div id="hud" class="panel">
    <div class="row" style="gap:18px;">
      <div>
        <div class="name" style="color:var(--player)">ゆうしゃ</div>
        <div class="bar" style="width:180px;"><div id="php" class="hp" style="width:100%"></div></div>
        <div class="stat" id="pstat">HP 50/50  MP 12  速さ 8</div>
      </div>
      <div>
        <div class="name" style="color:var(--enemy)">スライム</div>
        <div class="bar" style="width:180px;"><div id="ehp" class="ehp" style="width:100%"></div></div>
        <div class="stat" id="estat">HP 40/40  速さ 5</div>
      </div>
    </div>
    <div id="log">スライムが あらわれた！</div>
  </div>

  <div id="ui" class="panel">
    <div id="cmds">
      <button data-cmd="attack">たたかう</button>
      <button data-cmd="skill">スキル</button>
      <button data-cmd="guard">ぼうぎょ</button>
      <button data-cmd="run">にげる</button>
    </div>
    <div id="skills" style="display:none; margin-top:8px;">
      <button data-skill="crit">かいしん斬り<span class="sub"><br>命中60% / 大ダメ</span></button>
      <button data-skill="heal">ヒール<span class="sub"><br>HPを中回復</span></button>
    </div>
  </div>
</div>

<script>
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
let W = cv.width, H = cv.height;

const logEl = document.getElementById('log');
const phpEl = document.getElementById('php');
const ehpEl = document.getElementById('ehp');
const pstat = document.getElementById('pstat');
const estat = document.getElementById('estat');
const cmds = document.getElementById('cmds');
const skills = document.getElementById('skills');

addEventListener('resize', ()=>{ /* canvasはCSSで拡大縮小 */ });

/* 戦闘データ */
const player = {name:'ゆうしゃ', hp:50, maxHp:50, mp:12, atk:10, def:6, spd:8, guarding:false};
const enemy  = {name:'スライム', hp:40, maxHp:40, atk:8, def:3, spd:5, phase:0};

function updHUD(){
  phpEl.style.width = (100*player.hp/player.maxHp)+'%';
  ehpEl.style.width = (100*enemy.hp/enemy.maxHp)+'%';
  pstat.textContent = `HP ${player.hp}/${player.maxHp}  MP ${player.mp}  速さ ${player.spd}`;
  estat.textContent = `HP ${enemy.hp}/${enemy.maxHp}  速さ ${enemy.spd}`;
}
updHUD();

/* 演出 */
const sprites = {
  enemy:{x: W*0.72, y: H*0.46, r: 46, hue: 200},
  player:{x: W*0.25, y: H*0.62, r: 40, hue: 140}
};

function drawBG(){
  // ほこらっぽい背景
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#1b2233'); g.addColorStop(1,'#0f1422');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  ctx.fillStyle='#101828';
  for(let i=0;i<8;i++){
    ctx.fillRect(60+i*70, 120, 30, 200);
  }
  // 地面
  ctx.fillStyle='#0a1320';
  ctx.fillRect(0, H*0.68, W, H*0.32);
}

function drawBlob(sp, color){
  ctx.save();
  ctx.translate(sp.x, sp.y);
  ctx.fillStyle=color;
  ctx.beginPath();
  ctx.ellipse(0,0, sp.r*1.2, sp.r, 0, 0, Math.PI*2);
  ctx.fill();
  // 目
  ctx.fillStyle='#fff';
  ctx.beginPath(); ctx.arc(-12,-6,8,0,Math.PI*2); ctx.arc(12,-6,8,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#223';
  ctx.beginPath(); ctx.arc(-12,-6,4,0,Math.PI*2); ctx.arc(12,-6,4,0,Math.PI*2); ctx.fill();
  // ハイライト
  ctx.fillStyle='rgba(255,255,255,.2)';
  ctx.beginPath(); ctx.ellipse(-18,-16,14,10,0,0,Math.PI*2); ctx.fill();
  ctx.restore();
}

function floatText(x,y,text,color){
  const el = document.createElement('div');
  el.className='float';
  el.textContent = text;
  el.style.left = (x-10) + 'px';
  el.style.top  = (y-10) + 'px';
  el.style.color = color;
  document.body.appendChild(el);
  let t=0;
  const id = setInterval(()=>{
    t+=16; el.style.transform = `translateY(${-t/40}px)`; el.style.opacity = String(1 - t/600);
    if(t>600){ clearInterval(id); el.remove(); }
  },16);
}

function shake(whom){
  const target = (whom==='enemy')?cv:cv; // キャンバス全体を揺らす
  target.classList.remove('shake'); void target.offsetWidth; target.classList.add('shake');
}

/* 描画ループ（軽量） */
function render(){
  drawBG();
  drawBlob(sprites.enemy, 'hsl(200,70%,60%)');
  drawBlob(sprites.player, 'hsl(140,70%,60%)');
  requestAnimationFrame(render);
}
render();

/* 乱数・ダメージ計算 */
const rand = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;

function physDamage(attacker, defender){
  const base = Math.max(1, attacker.atk - Math.floor(defender.def/2));
  const spread = rand(-2,2);
  return Math.max(1, base + spread);
}

/* ログ */
function say(t){ logEl.textContent = t; }

/* ターン進行 */
let busy = false;

function endCheck(){
  if(enemy.hp<=0){ enemy.hp=0; updHUD(); say('スライムを たおした！'); disableUI(true); return true; }
  if(player.hp<=0){ player.hp=0; updHUD(); say('ゆうしゃは たおれた…'); disableUI(true); return true; }
  return false;
}

function disableUI(all){
  [...cmds.querySelectorAll('button')].forEach(b=> b.disabled = all);
  [...skills.querySelectorAll('button')].forEach(b=> b.disabled = all);
}

function playerTurn(act){
  if(busy) return;
  busy = true; disableUI(true);
  player.guarding = (act.type==='guard');

  const goEnemy = ()=> enemyTurn();

  if(act.type==='attack'){
    say('ゆうしゃの こうげき！');
    setTimeout(()=>{
      shake('enemy');
      const dmg = physDamage(player, enemy);
      enemy.hp = Math.max(0, enemy.hp - dmg);
      updHUD(); floatText(sprites.enemy.x, sprites.enemy.y-40, '-'+dmg, '#ffb3c1');
      if(endCheck()) return;
      setTimeout(goEnemy, 500);
    }, 350);

  }else if(act.type==='skill'){
    if(act.which==='crit'){
      if(player.mp<3){ say('MPが たりない！'); busy=false; disableUI(false); return; }
      say('ゆうしゃは かいしん斬り！');
      player.mp -= 3; updHUD();
      setTimeout(()=>{
        if(Math.random() < 0.60){
          shake('enemy');
          const dmg = physDamage(player, enemy)*2 + rand(2,5);
          enemy.hp = Math.max(0, enemy.hp - dmg);
          updHUD(); floatText(sprites.enemy.x, sprites.enemy.y-40, 'CRIT! -'+dmg, '#ffd26a');
          if(endCheck()) return;
        }else{
          say('しかし うまく きまらなかった…');
        }
        setTimeout(goEnemy, 600);
      }, 400);

    }else if(act.which==='heal'){
      if(player.mp<4){ say('MPが たりない！'); busy=false; disableUI(false); return; }
      say('ゆうしゃは ヒールを となえた！');
      player.mp -= 4; updHUD();
      setTimeout(()=>{
        const rec = rand(10,18);
        player.hp = Math.min(player.maxHp, player.hp + rec);
        updHUD(); floatText(sprites.player.x, sprites.player.y-50, '+'+rec, '#8dffb3');
        setTimeout(goEnemy, 500);
      }, 350);
    }

  }else if(act.type==='guard'){
    say('ゆうしゃは みを まもっている。');
    setTimeout(goEnemy, 400);

  }else if(act.type==='run'){
    say('にげだした！');
    setTimeout(()=>{
      if(Math.random() < 0.45){
        say('うまく にげきれた！'); disableUI(true);
      }else{
        say('しかし まわりこまれてしまった！');
        setTimeout(goEnemy, 600);
      }
    }, 350);
  }
}

function enemyTurn(){
  if(endCheck()) { busy=false; return; }
  // すばやさ判定で先手/後手（ここでは単純に1回ずつ）
  say('スライムの こうげき！');
  setTimeout(()=>{
    shake('player');
    let dmg = physDamage(enemy, player);
    if(player.guarding) dmg = Math.max(1, Math.floor(dmg/2));
    player.hp = Math.max(0, player.hp - dmg);
    updHUD(); floatText(sprites.player.x, sprites.player.y-50, '-'+dmg, '#ff93a0');
    player.guarding=false;
    if(endCheck()) { busy=false; return; }
    setTimeout(()=>{ busy=false; disableUI(false); say('コマンド？'); }, 600);
  }, 450);
}

/* 入力（タッチ/クリック） */
cmds.addEventListener('pointerdown', e=>{
  if(!(e.target instanceof HTMLButtonElement)) return;
  const cmd = e.target.dataset.cmd;
  if(cmd==='attack') playerTurn({type:'attack'});
  if(cmd==='skill'){ cmds.style.display='none'; skills.style.display='grid'; say('スキルを えらんでください'); }
  if(cmd==='guard') playerTurn({type:'guard'});
  if(cmd==='run')   playerTurn({type:'run'});
});

skills.addEventListener('pointerdown', e=>{
  if(!(e.target instanceof HTMLButtonElement)) return;
  const sk = e.target.dataset.skill;
  if(sk==='crit') playerTurn({type:'skill', which:'crit'});
  if(sk==='heal') playerTurn({type:'skill', which:'heal'});
  // スキル使用後は自動で戻る
  cmds.style.display='grid'; skills.style.display='none';
});

document.addEventListener('keydown', (e)=>{
  // キーショートカット（PC用）
  const k = e.key.toLowerCase();
  if(k==='1') cmds.querySelector('[data-cmd="attack"]').click();
  if(k==='2') cmds.querySelector('[data-cmd="skill"]').click();
  if(k==='3') cmds.querySelector('[data-cmd="guard"]').click();
  if(k==='4') cmds.querySelector('[data-cmd="run"]').click();
});

/* 初期メッセージ */
setTimeout(()=> say('コマンド？'), 800);
</script>
</body>
</html>